<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Calle a Calle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* --- ESTILOS GENERALES (Existentes) --- */
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body { font-family: system-ui, sans-serif; background-color: #1a1a1a; }
    .hidden { display: none !important; }
    
    #game-screen { display: flex; height: 100%; width: 100%; }
    #game-map-container { flex: 1; }

    aside { 
      width: 300px;
      padding: 1rem;
      box-shadow: 2px 0 4px rgba(0,0,0,.15); 
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Cambiado para controlar la animación del panel */
      background-color: white;
      z-index: 10;
      position: relative; /* Necesario para posicionar los paneles */
    }

    #background-map {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1; filter: blur(4px) brightness(0.7); transition: opacity 0.8s ease-in-out;
    }
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 2; display: flex; align-items: center; justify-content: center;
        transition: opacity 0.5s ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
    }
    #google-login-btn { animation: pulse 2.5s infinite; }
    
    button { cursor: pointer; }
    button:not(.login-btn) {
      width: 100%; padding: .45rem; border: none; border-radius: 6px;
      background: #007BFF; color: #fff; font-size: 1rem;
      box-sizing: border-box; transition: transform 0.05s ease-in-out, background-color 0.2s;
    }
    button:not(.login-btn):not(:disabled):hover { background-color: #0069d9; }
    button:not(.login-btn):not(:disabled):active { transform: scale(0.97); }
    button:not(.login-btn):disabled { opacity: .4; cursor: default; }

    .gradient-text {
        font-size: 2.25rem; font-weight: 700; text-align: center;
        background: linear-gradient(to right, #3b82f6, #8b5cf6);
        -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    
    #question { font-weight: 700; margin: .5rem 0; }
    #fb { margin: .5rem 0; }
    #score-display { font-size: 1.1rem; font-weight: bold; color: #333; }
    .loader { display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 10px; padding: 10px; background-color: #333; border-radius: 8px; }
    .loading-text { color: white; font-size: 12pt; font-weight: 600; }
    .loading-bar-background { --height: 20px; display: flex; align-items: center; box-sizing: border-box; padding: 3px; width: 100%; height: var(--height); background-color: #212121; box-shadow: #0c0c0c -2px 2px 4px 0px inset; border-radius: calc(var(--height) / 2); }
    .loading-bar { position: relative; display: flex; justify-content: center; flex-direction: column; height: 100%; width: 0%; overflow: hidden; background: #007BFF; border-radius: 10px; transition: width 0.2s ease-out; }

    /* --- NUEVOS ESTILOS PARA EL MENÚ Y PANELES --- */
    #main-content {
      flex-grow: 1;
      position: relative;
    }

    .content-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 1rem;
      border-radius: 1.5rem;
      background-color: rgba(17, 24, 39, 0.8); /* bg-gray-900 bg-opacity-80 */
      backdrop-filter: blur(4px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease-in-out;
      overflow-y: auto;
      z-index: 20;
    }
    .content-panel.visible {
      transform: translateY(0);
      opacity: 1;
    }
    
    .menu {
      margin-top: auto; /* Empuja el menú hacia abajo */
      padding: 0.5rem;
      background-color: #f8f9fa;
      position: relative;
      display: flex;
      justify-content: center;
      border-radius: 15px;
      box-shadow: 0 10px 25px 0 rgba(0, 0, 0, 0.075);
      z-index: 30;
    }

    .menu-link {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 70px;
      height: 50px;
      border-radius: 8px;
      position: relative;
      z-index: 1;
      overflow: hidden;
      transform-origin: center left;
      transition: width 0.2s ease-in;
      text-decoration: none;
      color: #343a40;
    }
    
    .menu-link:before {
      position: absolute;
      z-index: -1;
      content: "";
      display: block;
      border-radius: 8px;
      width: 100%;
      height: 100%;
      top: 0;
      transform: translateX(100%);
      transition: transform 0.2s ease-in;
      transform-origin: center right;
      background-color: #e9ecef;
    }

    .menu-link:hover,
    .menu-link:focus,
    .menu-link.active { /* Estilo para el botón activo */
      outline: 0;
      width: 130px;
      color: #007bff;
    }

    .menu-link:hover:before,
    .menu-link:focus:before,
    .menu-link.active:before {
      transform: translateX(0);
    }
    
    .menu-link:hover .link-title,
    .menu-link:focus .link-title,
    .menu-link.active .link-title {
      transform: translateX(0);
      opacity: 1;
    }

    .link-icon {
      width: 28px;
      height: 28px;
      display: block;
      flex-shrink: 0;
      left: 21px; /* Centrado en 70px */
      position: absolute;
      transition: transform 0.2s ease-in;
    }
    
    .menu-link:hover .link-icon,
    .menu-link:focus .link-icon,
    .menu-link.active .link-icon {
        transform: translateX(-15px); /* Mueve el icono a la izquierda */
    }

    .link-title {
      opacity: 0;
      transform: translateX(100%);
      transition: transform 0.2s ease-in, opacity 0.1s ease-in;
      transform-origin: center right;
      display: block;
      text-align: center;
      text-indent: 18px; /* Espacio para el icono */
      width: 100%;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="background-map"></div>
  <div id="login-screen">
    <div class="grid gap-8">
      <section class="bg-gradient-to-r from-blue-800 to-purple-800 rounded-3xl">
        <div class="border-8 border-transparent rounded-xl bg-gray-900 bg-opacity-80 backdrop-blur-sm shadow-xl p-8 m-2 text-white">
          <h1 class="text-5xl font-bold text-center cursor-default">Calle a Calle</h1>
          <p class="text-center text-gray-300 mt-2 mb-8">Inicia sesión con Google para empezar a jugar</p>
          <div class="flex justify-center">
            <button id="google-login-btn" class="login-btn p-3 rounded-full bg-white hover:scale-105 transition transform duration-300 shadow-lg">
              <img class="w-10 h-10" loading="lazy" src="https://ucarecdn.com/8f25a2ba-bdcf-4ff1-b596-088f330416ef/" alt="Google" />
            </button>
          </div>
          <div class="mt-8 text-center text-xs text-gray-400">
            <p>Al iniciar sesión, aceptas nuestros Términos y Política de Privacidad.</p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="game-screen" class="hidden">
    <aside>
      <div id="main-content">
        <div id="game-panel" class="content-panel visible" style="background: none; border: none; backdrop-filter: none;">
            <h1 class="gradient-text">Calle a Calle</h1>
            <button id="drawZone">Establecer zona</button>
            <button id="undoPoint" class="hidden">Retroceder Punto</button>
            <button id="start" class="hidden" disabled>Start</button>
            <button id="repeatZone" class="hidden" disabled>Repetir Zona</button>
            <button id="saveZoneBtn" class="hidden" style="background-color: #ffc107; color: black;">Guardar Zona</button>
            <button id="next" class="hidden" disabled>Siguiente</button>
            <p id="question"></p>
            <p id="score-display" class="hidden">Calles acertadas: <span id="score">0 / 0</span></p>
            <div id="loader-container" class="loader hidden">
              <div id="loading-text" class="loading-text"></div>
              <div class="loading-bar-background">
                <div id="progress-bar" class="loading-bar"></div>
              </div>
            </div>
            <p id="fb"></p>
        </div>
        <div id="saved-zones-panel" class="content-panel">
            <h3 class="font-bold text-xl mb-4">Mis Zonas Guardadas</h3>
            <div id="saved-zones-list" class="space-y-2"></div>
        </div>
        <div id="stats-panel" class="content-panel">
            <h3 class="font-bold text-xl mb-4">Estadísticas</h3>
            <div id="stats-content"></div>
        </div>
        <div id="profile-panel" class="content-panel">
            <h3 class="font-bold text-xl mb-4">Perfil</h3>
            <div id="user-info-content" class="text-center"></div>
            <button id="logout-btn" class="mt-4" style="background-color: #dc3545;">Cerrar Sesión</button>
        </div>
      </div>
      
      <div class="menu">
        <a href="#" class="menu-link active" data-panel="game-panel">
          <span class="link-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M213.3815,109.61945,133.376,36.88436a8,8,0,0,0-10.76339.00036l-79.9945,72.73477A8,8,0,0,0,40,115.53855V208a8,8,0,0,0,8,8H208a8,8,0,0,0,8-8V115.53887A8,8,0,0,0,213.3815,109.61945Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path></svg>
          </span>
          <span class="link-title">Juego</span>
        </a>
        <a href="#" class="menu-link" data-panel="saved-zones-panel">
          <span class="link-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M128,24,94.2,90.41,24,101.41l50.8,49.5L62.1,224,128,189.9,193.9,224,181.2,150.91,232,101.41l-70.2-.1Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path></svg>
          </span>
          <span class="link-title">Zonas</span>
        </a>
        <a href="#" class="menu-link" data-panel="stats-panel">
          <span class="link-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M40,168V104a8,8,0,0,1,8-8H96a8,8,0,0,1,0,16H56v56a8,8,0,0,1-16,0Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M208,104v64a8,8,0,0,1-8,8H160a8,8,0,0,1,0-16h40V112a8,8,0,0,1,16,0Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><polyline points="40 88 40 56 72 56" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></polyline><polyline points="216 168 216 200 184 200" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></polyline><line x1="160" y1="52.4" x2="96" y2="84" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line></svg>
          </span>
          <span class="link-title">Stats</span>
        </a>
        <a href="#" class="menu-link" data-panel="profile-panel">
          <span class="link-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><circle cx="128" cy="96" r="64" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="16"></circle><path d="M30.989,215.99064a112.03731,112.03731,0,0,1,194.02311.002" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path></svg>
          </span>
          <span class="link-title">Perfil</span>
        </a>
      </div>
    </aside>
    <div id="game-map-container"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
    
      const SUPABASE_URL = 'https://hppzwfwtedghpsxfonoh.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcHp3Znd0ZWRnaHBzeGZvbm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMjQzNDMsImV4cCI6MjA2OTcwMDM0M30.BAh6i5iJ5YkDBoydfkC9azAD4eMdYBkEBdxws9kj5Hg';
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // --- Referencias a elementos del DOM ---
      const loginScreen = document.getElementById('login-screen');
      const gameScreen = document.getElementById('game-screen');
      const backgroundMapContainer = document.getElementById('background-map');
      const googleLoginBtn = document.getElementById('google-login-btn');
      
      // --- Variables de estado del juego ---
      let backgroundMap, animationInterval, gameMap = null;
      const COL_ZONE = '#663399', COL_TRACE = '#007a2f', COL_DASH = '#1976d2';
      let drawing=false, zonePoly=null, tempMarkers=[], zonePoints=[], oldZonePoly=null;
      let playing=false, qIdx=0, target=null, userMk, guide, streetGrp;
      let streetList = [], totalQuestions = 0, streetsGuessedCorrectly = 0, lastGameZonePoints = [];

      // --- Lógica de Autenticación ---
      async function signInWithGoogle() { 
        await supabaseClient.auth.signInWithOAuth({ 
          provider: 'google',
          options: { redirectTo: window.location.origin }
        }); 
      }
      async function signOut() { await supabaseClient.auth.signOut(); }
      
      function handleAuthStateChange(event, session) {
        const user = session ? session.user : null;
        if (user) {
          loginScreen.style.opacity = '0';
          setTimeout(() => loginScreen.classList.add('hidden'), 500);
          gameScreen.classList.remove('hidden');
          if (animationInterval) clearInterval(animationInterval);
          backgroundMapContainer.style.opacity = '0';
          backgroundMapContainer.classList.add('hidden');
          
          document.getElementById('user-info-content').innerHTML = `<p style="margin: 0 0 10px 0; font-size: 0.9rem;">Hola,</p><p><strong>${user.email}</strong></p>`;
          document.getElementById('logout-btn').addEventListener('click', signOut);
          
          if (!gameMap) initGame();
          else setTimeout(() => gameMap.invalidateSize(), 10);
        } else {
          loginScreen.classList.remove('hidden');
          loginScreen.style.opacity = '1';
          gameScreen.classList.add('hidden');
          if (!backgroundMap) initBackgroundMap();
          backgroundMapContainer.classList.remove('hidden');
          backgroundMapContainer.style.opacity = '1';
        }
      }

      function initBackgroundMap() {
          backgroundMap = L.map('background-map', { zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false });
          L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', { attribution: '', maxZoom: 19 }).addTo(backgroundMap);
          const pos1 = [38.88, -6.97], pos2 = [38.885, -6.96], pos3 = [38.875, -6.98];
          let targetPos = pos2;
          backgroundMap.setView(pos1, 15);
          if (animationInterval) clearInterval(animationInterval);
          animationInterval = setInterval(() => {
              if (!backgroundMap) return;
              backgroundMap.panTo(targetPos, { animate: true, duration: 15 });
              if (backgroundMap.distance(backgroundMap.getCenter(), targetPos) < 100) targetPos = (targetPos === pos2) ? pos3 : pos2;
          }, 100);
      }
      
      // --- Lógica del Menú y Paneles ---
      function setupMenu() {
        const menuLinks = document.querySelectorAll('.menu-link');
        const contentPanels = document.querySelectorAll('.content-panel');

        menuLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const panelId = link.dataset.panel;
            
            // Gestionar estado activo del link
            menuLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            // Mostrar el panel correspondiente
            contentPanels.forEach(panel => {
              if (panel.id === panelId) {
                // Si el panel que vamos a mostrar es el de zonas o stats, recargamos sus datos
                if (panelId === 'saved-zones-panel') displaySavedZones();
                if (panelId === 'stats-panel') displayStats();
                panel.classList.add('visible');
              } else {
                panel.classList.remove('visible');
              }
            });
          });
        });
      }

      // --- Lógica Principal del Juego ---
      function initGame(){
        const btnDraw = document.getElementById('drawZone');
        const btnUndo = document.getElementById('undoPoint');
        const bStart = document.getElementById('start');
        const btnRepeat = document.getElementById('repeatZone');
        const bNext = document.getElementById('next');
        const btnSaveZone = document.getElementById('saveZoneBtn');
        
        gameMap = L.map('game-map-container',{zoomSnap:0.25});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',{
          attribution: '© OSM & CARTO', subdomains:'abcd', maxZoom:19
        }).addTo(gameMap);
        gameMap.setView([38.88, -6.97], 13);
        
        setTimeout(() => gameMap.invalidateSize(), 10);

        btnDraw.addEventListener('click', startDrawing);
        btnUndo.addEventListener('click', undoLastPoint);
        bNext.addEventListener('click', () => { bNext.disabled=true; nextQ(); });
        btnRepeat.addEventListener('click', repeatLastZone);
        btnSaveZone.addEventListener('click', saveCurrentZone);
        setupStartButton(bStart);
        setupMenu(); // Inicializamos el nuevo menú
      }
      
      // ... (El resto de funciones del juego como setupStartButton, startDrawing, onMapClick, etc., permanecen igual) ...
      
      function setupStartButton(bStart) {
        bStart.onclick = async () => {
            if (oldZonePoly) gameMap.removeLayer(oldZonePoly);
            if (!zonePoly) return;
            if (drawing) {
                drawing = false;
                gameMap.off('click', addVertex);
                tempMarkers.forEach(m => gameMap.removeLayer(m));
                tempMarkers = [];
            }
            document.getElementById('undoPoint').classList.add('hidden');
            bStart.disabled = true;
            bStart.textContent = 'Cargando calles...';
            await preloadStreets();
            bStart.textContent = 'Iniciar juego';
            bStart.onclick = () => {
                playing = true; qIdx = 0; streetsGuessedCorrectly = 0;
                document.getElementById('score-display').classList.remove('hidden');
                document.getElementById('score').textContent = `0 / ${totalQuestions}`;
                bStart.classList.add('hidden');
                document.getElementById('next').classList.remove('hidden');
                gameMap.fitBounds(zonePoly.getBounds(), { padding: [50, 50] });
                nextQ();
            };
            if (totalQuestions > 0) {
              bStart.disabled = false;
            } else {
              document.getElementById('fb').textContent = 'No se encontraron calles. Dibuja otra zona.';
              bStart.classList.add('hidden');
              document.getElementById('drawZone').classList.remove('hidden');
            }
        };
      }

      function startDrawing(){
        const fb = document.getElementById('fb');
        const btnDraw = document.getElementById('drawZone');
        const btnUndo = document.getElementById('undoPoint');
        const bStart = document.getElementById('start');
        const btnRepeat = document.getElementById('repeatZone');
        const btnSaveZone = document.getElementById('saveZoneBtn');
        if (zonePoly) gameMap.removeLayer(zonePoly);
        if (oldZonePoly) gameMap.removeLayer(oldZonePoly);
        zonePoints = []; tempMarkers = []; zonePoly = null;
        playing = false;
        drawing = true;
        fb.textContent = 'Haz click para añadir vértices. Con 3 se habilita Start. Haz click en el primer vértice para cerrar.';
        btnDraw.classList.add('hidden');
        btnRepeat.classList.add('hidden');
        btnSaveZone.classList.add('hidden');
        btnUndo.classList.remove('hidden');
        bStart.classList.remove('hidden');
        bStart.disabled = true;
        bStart.textContent = 'Start';
        setupStartButton(bStart);
        gameMap.on('click', addVertex);
      }

      function addVertex(e){
        const { latlng } = e;
        if(zonePoints.length >= 3 && latlng.equals(zonePoints[0])){ finishPolygon(); return; }
        const mk = L.circleMarker(latlng, { radius:5, color:COL_ZONE }).addTo(gameMap);
        tempMarkers.push(mk);
        zonePoints.push(latlng);
        if(zonePoly) gameMap.removeLayer(zonePoly);
        zonePoly = L.polygon(zonePoints, { color:COL_ZONE, weight:2, fillOpacity:0.1 }).addTo(gameMap);
        if(zonePoints.length >= 3){ 
          document.getElementById('fb').textContent = 'Zona mínima definida. Puedes cerrar o añadir más puntos.';
          document.getElementById('start').disabled = false; 
        }
      }

      function finishPolygon(){
        drawing = false;
        gameMap.off('click', addVertex);
        tempMarkers.forEach(m=>gameMap.removeLayer(m));
        tempMarkers = [];
        zonePoly.addLatLng(zonePoints[0]);
        document.getElementById('fb').textContent = 'Zona cerrada. Pulsa Start para buscar calles.';
        document.getElementById('undoPoint').classList.add('hidden');
        document.getElementById('start').disabled = false;
      }
      
      function undoLastPoint() {
        if (!drawing || zonePoints.length === 0) return;
        zonePoints.pop();
        const lastMarker = tempMarkers.pop();
        if (lastMarker) gameMap.removeLayer(lastMarker);
        if (zonePoly) gameMap.removeLayer(zonePoly);
        zonePoly = null;
        if (zonePoints.length >= 2) {
            zonePoly = L.polygon(zonePoints, { color: COL_ZONE, weight: 2, fillOpacity: 0.1 }).addTo(gameMap);
        }
        document.getElementById('start').disabled = zonePoints.length < 3;
        document.getElementById('fb').textContent = zonePoints.length > 0 ? 'Punto eliminado. Sigue añadiendo.' : 'Haz click para añadir vértices.';
      }

      async function repeatLastZone() {
        if (lastGameZonePoints.length < 3) return;
        startDrawing();
        drawing = false;
        gameMap.off('click', addVertex);
        zonePoints = [...lastGameZonePoints];
        zonePoly = L.polygon(zonePoints, { color: COL_ZONE, weight: 2, fillOpacity: 0.1 }).addTo(gameMap);
        const bStart = document.getElementById('start');
        document.getElementById('drawZone').classList.add('hidden');
        document.getElementById('repeatZone').classList.add('hidden');
        document.getElementById('undoPoint').classList.add('hidden');
        bStart.classList.remove('hidden');
        bStart.disabled = false;
        bStart.textContent = 'Start';
        setupStartButton(bStart);
        document.getElementById('fb').textContent = 'Zona anterior cargada. Pulsa Start.';
      }

      function onMapClick(e){
        if(!playing) return; 
        gameMap.off('click', onMapClick);
        if (userMk) gameMap.removeLayer(userMk);
        userMk = L.marker(e.latlng).addTo(gameMap);
        streetGrp = drawStreet(); 
        if(streetGrp){
          const streetCheck = getDistanceToStreet(userMk.getLatLng(), streetGrp);
          const distance = streetCheck.distance;
          const clickTolerance = 30;
          if (distance <= clickTolerance) {
            streetsGuessedCorrectly++;
            document.getElementById('fb').textContent = `¡Correcto! Has acertado.`;
          } else {
            document.getElementById('fb').textContent = `Casi, pero no has hecho clic sobre el lugar (a ${Math.round(distance)} metros).`;
          }
          document.getElementById('score').textContent = `${streetsGuessedCorrectly} / ${totalQuestions}`;
          if (streetCheck.point) {
            guide = L.polyline([userMk.getLatLng(), streetCheck.point], { dashArray:'6 4', color:COL_DASH }).addTo(gameMap);
          }
        } else {
          document.getElementById('fb').textContent = 'Error: No se pudo dibujar el lugar. Pulsa Siguiente.';
        }
        document.getElementById('next').disabled=false;
      }

      function clear(){ 
        if (!gameMap) return;
        [userMk, guide, streetGrp].forEach(layer => {
            if (layer && gameMap.hasLayer(layer)) gameMap.removeLayer(layer);
        });
        userMk = guide = streetGrp = null; 
      }

      async function preloadStreets() {
          const fb = document.getElementById('fb');
          const loaderContainer = document.getElementById('loader-container');
          const loadingText = document.getElementById('loading-text');
          const scoreEl = document.getElementById('score');

          fb.textContent = '';
          loaderContainer.classList.remove('hidden');
          loadingText.innerHTML = `Identificando calles en la zona...`;

          try {
              const zoneParam = zonePoints.map(p => `${p.lat},${p.lng}`).join(';');
              const response = await fetch(`/api/getStreets?zone=${encodeURIComponent(zoneParam)}`);
              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'Server error while loading streets.');
              }
              const data = await response.json();
              streetList = data.streets;
              totalQuestions = streetList.length;
              streetList.sort(() => Math.random() - 0.5);
              if (totalQuestions > 0) fb.textContent = `Se han encontrado y validado ${totalQuestions} lugares. ¡Listo para jugar!`;
              else fb.textContent = 'No se han encontrado lugares válidos en la zona. Dibuja un polígono más grande.';
              scoreEl.textContent = `0 / ${totalQuestions}`;
          } catch (error) {
              console.error(error);
              fb.textContent = `Hubo un error al cargar las calles. ${error.message}`;
          } finally {
              loaderContainer.classList.add('hidden');
          }
      }
      
      function drawStreet(){
        const g = L.layerGroup().addTo(gameMap);
        if (!target || !Array.isArray(target) || target.length === 0) {
          document.getElementById('fb').textContent = '⚠️ No se encontró la geometría para este lugar.';
          gameMap.removeLayer(g);
          return null;
        }
        target.forEach(geom => {
            if (geom.isClosed) L.polygon(geom.points, { color: COL_TRACE, weight: 4, fillOpacity: 0.2 }).addTo(g);
            else L.polyline(geom.points, { color: COL_TRACE, weight: 8 }).addTo(g);
        });
        return g;
      }

      function getDistanceToStreet(userPoint, streetLayer) {
          let minDistance = Infinity;
          let closestPointOnStreet = null;
          if (!gameMap) return { distance: Infinity, point: null };
          streetLayer.eachLayer(layer => {
              let latlngs;
              if (layer instanceof L.Polygon) latlngs = layer.getLatLngs()[0];
              else if (layer instanceof L.Polyline) latlngs = layer.getLatLngs();
              else return;
              if (latlngs.length < 2) return;
              for (let i = 0; i < latlngs.length - 1; i++) {
                  const p1 = gameMap.latLngToLayerPoint(latlngs[i]), p2 = gameMap.latLngToLayerPoint(latlngs[i + 1]);
                  const userP = gameMap.latLngToLayerPoint(userPoint);
                  const a = userP.x - p1.x, b = userP.y - p1.y, c = p2.x - p1.x, d = p2.y - p1.y;
                  let dot = a * c + b * d, len_sq = c * c + d * d;
                  let param = len_sq !== 0 ? dot / len_sq : -1;
                  let xx, yy;
                  if (param < 0) { xx = p1.x; yy = p1.y; }
                  else if (param > 1) { xx = p2.x; yy = p2.y; }
                  else { xx = p1.x + param * c; yy = p1.y + param * d; }
                  const dx = userP.x - xx, dy = userP.y - yy;
                  const dist = Math.sqrt(dx * dx + dy * dy);
                  if (dist < minDistance) {
                      minDistance = dist;
                      closestPointOnStreet = gameMap.layerPointToLatLng([xx, yy]);
                  }
              }
          });
          return { distance: minDistance, point: closestPointOnStreet };
      }

      function endGame() {
        playing = false;
        const bStart = document.getElementById('start');
        document.getElementById('fb').textContent = `¡Juego terminado! Has acertado ${streetsGuessedCorrectly} de ${totalQuestions}.`;
        document.getElementById('question').textContent = 'Pulsa en el menú inferior para ver tus zonas o empezar de nuevo.';
        document.getElementById('score-display').classList.add('hidden');
        if (zonePoly) {
            zonePoly.setStyle({ color: '#696969', weight: 2, dashArray: '5, 5', fillOpacity: 0.05 });
            oldZonePoly = zonePoly;
        }
        lastGameZonePoints = [...zonePoints];
        saveGameStats(streetsGuessedCorrectly, totalQuestions);
        
        document.getElementById('next').classList.add('hidden');
        document.getElementById('drawZone').classList.add('hidden'); 
        document.getElementById('repeatZone').classList.add('hidden'); 
        document.getElementById('saveZoneBtn').classList.remove('hidden');
        bStart.classList.add('hidden');
        zonePoly = null; 
        zonePoints = []; 
        streetList = []; 
        totalQuestions = 0;
        setupStartButton(bStart);
        gameMap.off('click', onMapClick);
      }

      function nextQ(){
        clear();
        const bNext = document.getElementById('next');
        bNext.disabled = true;
        if(qIdx >= totalQuestions){ endGame(); return; }
        gameMap.on('click', onMapClick);
        const s = streetList[qIdx];
        target = s.geometries;
        qIdx++;
        document.getElementById('question').textContent = `Pregunta ${qIdx} / ${totalQuestions}: ¿Dónde está «${s.googleName}»?`;
        document.getElementById('fb').textContent = 'Haz clic en el mapa para responder.';
      }
      
      // --- Funciones de Datos (Zonas y Stats) ---
      async function saveCurrentZone() {
        const zoneName = prompt("Dale un nombre a esta zona:", "Mi barrio");
        if (!zoneName || zoneName.trim() === '') return;
        if (lastGameZonePoints.length < 3) return;
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            const zoneString = lastGameZonePoints.map(p => `${p.lat},${p.lng}`).join(';');
            const { error } = await supabaseClient
                .from('saved_zones')
                .insert({ user_id: session.user.id, name: zoneName, zone_points: zoneString });
            if (error) throw error;
            alert(`¡Zona "${zoneName}" guardada con éxito!`);
            document.getElementById('saveZoneBtn').classList.add('hidden');
        } catch (error) {
            console.error('Error al guardar la zona:', error.message);
            alert('Hubo un error al guardar la zona.');
        }
      }
      
      async function displaySavedZones() {
        const listContainer = document.getElementById('saved-zones-list');
        listContainer.innerHTML = '<p>Cargando zonas...</p>';
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            const { data: zones, error } = await supabaseClient
                .from('saved_zones')
                .select('id, name, zone_points')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false });
            if (error) throw error;
            listContainer.innerHTML = '';
            if (zones.length === 0) {
                listContainer.innerHTML = '<p>No tienes zonas guardadas.</p>';
                return;
            }
            zones.forEach(zone => {
                const zoneElement = document.createElement('button');
                zoneElement.className = 'w-full text-left p-3 mb-2 rounded-md bg-gray-700 hover:bg-blue-600 transition';
                zoneElement.innerHTML = `<span class="font-semibold block">${zone.name}</span>`;
                zoneElement.addEventListener('click', () => {
                    playFromHistory(zone.zone_points);
                    // Opcional: volver al panel de juego
                    document.querySelector('.menu-link[data-panel="game-panel"]').click();
                });
                listContainer.appendChild(zoneElement);
            });
        } catch (error) {
            console.error('Error cargando zonas guardadas:', error.message);
            listContainer.innerHTML = '<p class="text-red-400">Error al cargar zonas.</p>';
        }
      }

      async function saveGameStats(correct, total) {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || total === 0) return;
            await supabaseClient
                .from('game_stats')
                .insert({ user_id: session.user.id, correct_guesses: correct, total_questions: total });
        } catch (error) {
            console.error('Error guardando estadísticas:', error.message);
        }
      }

      async function displayStats() {
        const statsContent = document.getElementById('stats-content');
        statsContent.innerHTML = '<p>Calculando estadísticas...</p>';
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            const { data: stats, error } = await supabaseClient
                .from('game_stats')
                .select('correct_guesses, total_questions')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false })
                .limit(15);
            if (error) throw error;
            if (stats.length === 0) {
                statsContent.innerHTML = '<p>Juega una partida para ver tus estadísticas.</p>';
                return;
            }
            const totalCorrect = stats.reduce((sum, game) => sum + game.correct_guesses, 0);
            const totalPlayed = stats.reduce((sum, game) => sum + game.total_questions, 0);
            const percentage = totalPlayed > 0 ? Math.round((totalCorrect / totalPlayed) * 100) : 0;
            statsContent.innerHTML = `
                <div class="text-center">
                    <p class="text-5xl font-bold text-blue-400">${percentage}%</p>
                    <p class="text-lg text-gray-300 mt-2">de aciertos</p>
                    <p class="text-sm text-gray-400">(${totalCorrect} de ${totalPlayed} en las últimas partidas)</p>
                </div>`;
        } catch (error) {
            console.error('Error cargando estadísticas:', error.message);
            statsContent.innerHTML = '<p class="text-red-400">Error al cargar estadísticas.</p>';
        }
      }
      
      function playFromHistory(zoneString) {
        const points = zoneString.split(';').map(pair => {
          const [lat, lng] = pair.split(',');
          return { lat: parseFloat(lat), lng: parseFloat(lng) };
        });
        if (points.length < 3) return;
        startDrawing(); 
        drawing = false; 
        gameMap.off('click', addVertex);
        zonePoints = points.map(p => L.latLng(p.lat, p.lng));
        zonePoly = L.polygon(zonePoints, { color: COL_ZONE, weight: 2, fillOpacity: 0.1 }).addTo(gameMap);
        const bStart = document.getElementById('start');
        document.getElementById('drawZone').classList.add('hidden');
        document.getElementById('repeatZone').classList.add('hidden');
        document.getElementById('undoPoint').classList.add('hidden');
        bStart.classList.remove('hidden');
        bStart.disabled = false;
        bStart.textContent = 'Start';
        setupStartButton(bStart);
        document.getElementById('fb').textContent = 'Zona cargada. Pulsa Start.';
        gameMap.fitBounds(zonePoly.getBounds(), { padding: [50, 50] });
      }
      
      // --- Inicialización General ---
      googleLoginBtn.addEventListener('click', signInWithGoogle);
      supabaseClient.auth.onAuthStateChange(handleAuthStateChange);

    });
  </script>
</body>
</html>